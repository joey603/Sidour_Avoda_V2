name: build-macos-app

on:
  workflow_dispatch:
  push:
    branches:
      - macos-build

jobs:
  build:
    name: Build macOS (${{ matrix.runner }})
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-13   # Intel x86_64
          - runner: macos-14   # Apple Silicon arm64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller pillow
          if [ -f requirements.txt ]; then
            pip install -r requirements.txt
          elif [ -f "Sidour-avoda-Tzora-chevron/requirements.txt" ]; then
            pip install -r "Sidour-avoda-Tzora-chevron/requirements.txt"
          else
            echo "No requirements.txt found, continuing with PyInstaller only."
          fi

      - name: Build .app with PyInstaller
        shell: bash
        run: |
          set -euo pipefail
          PROJ_DIR="Sidour-avoda-Tzora-chevron"
          if [ -f "main.py" ]; then PROJ_DIR="."; fi
          cd "$PROJ_DIR"
          MAIN=main.py
          APP_NAME="SidourAvoda"
          EXTRA_ARGS=(
            --noconsole
            --windowed
            --name "$APP_NAME"
            --clean
            --paths .
            --hidden-import interface --hidden-import planning --hidden-import database --hidden-import horaire --hidden-import travailleur --hidden-import tkinter --hidden-import tkinter.ttk
          )
          # Bundle assets if present
          if [ -f assets/calender-2389150_960_720.png ]; then
            EXTRA_ARGS+=(--add-data "assets/calender-2389150_960_720.png:assets")
          fi
          if [ -f ../planning_data.db ]; then
            EXTRA_ARGS+=(--add-data "../planning_data.db:.")
          elif [ -f planning_data.db ]; then
            EXTRA_ARGS+=(--add-data "planning_data.db:.")
          fi
          echo "PyInstaller args: ${EXTRA_ARGS[@]} $MAIN"
          pyinstaller ${EXTRA_ARGS[@]} "$MAIN"
          echo "Built app at dist/$APP_NAME.app"

      - name: Create DMG with improved Gatekeeper handling
        shell: bash
        run: |
          set -euo pipefail
          PROJ_DIR="Sidour-avoda-Tzora-chevron"
          if [ -d "dist" ] && [ -d "dist/SidourAvoda.app" ]; then PROJ_DIR="."; fi
          APP_PATH="$PROJ_DIR/dist/SidourAvoda.app"
          [ -d "$APP_PATH" ] || { echo "App not found: $APP_PATH"; exit 1; }
          ARCH=$(uname -m)
          DMG_NAME="SidourAvoda-${ARCH}.dmg"
          
          # Stage folder
          STAGE="dmg_staging"
          rm -rf "$STAGE"; mkdir -p "$STAGE"
          cp -R "$APP_PATH" "$STAGE/"
          
          # Add Applications symlink for drag-and-drop install
          ln -s /Applications "$STAGE/Applications" || true
          
          # Create comprehensive README with multiple solutions
          cat > "$STAGE/ðŸ“‹ LIRE-AVANT-TOUT.txt" <<'TXT'
          Sidour Avoda - macOS
          ====================
          
          ðŸš¨ ATTENTION : macOS peut afficher un avertissement de sÃ©curitÃ©
          
          Solutions GRATUITES pour ouvrir l'application :
          
          ðŸŸ¢ SOLUTION 1 (RecommandÃ©e) :
          - Clic droit sur "SidourAvoda.app" 
          - SÃ©lectionner "Ouvrir"
          - Cliquer "Ouvrir" dans la popup
          
          ðŸŸ¢ SOLUTION 2 (Automatique) :
          - Double-cliquer sur "ðŸ”“ Ouvrir-SidourAvoda.command"
          - Entrer votre mot de passe si demandÃ©
          
          ðŸŸ¢ SOLUTION 3 (Manuelle) :
          - Ouvrir Terminal (Applications > Utilitaires)
          - Taper : xattr -dr com.apple.quarantine /Applications/SidourAvoda.app
          - Puis double-cliquer sur l'app
          
          ðŸŸ¢ SOLUTION 4 (PrÃ©fÃ©rences SystÃ¨me) :
          - PrÃ©fÃ©rences SystÃ¨me > SÃ©curitÃ© et confidentialitÃ©
          - Cliquer "Autoriser" Ã  cÃ´tÃ© de SidourAvoda
          
          âœ… AprÃ¨s la premiÃ¨re ouverture, l'app fonctionnera normalement.
          
          Note : Cette app est dÃ©veloppÃ©e en Python et n'est pas signÃ©e par Apple,
          mais elle est 100% sÃ»re et open source.
          TXT
          
          # Create automatic opener script
          cat > "$STAGE/ðŸ”“ Ouvrir-SidourAvoda.command" <<'SH'
          #!/bin/bash
          set -euo pipefail
          
          echo "ðŸ”“ Ouverture automatique de Sidour Avoda..."
          echo "Cette action peut demander votre mot de passe."
          echo ""
          
          # Get script directory
          SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"
          APP_PATH="$SCRIPT_DIR/SidourAvoda.app"
          
          if [ ! -d "$APP_PATH" ]; then
            echo "âŒ Erreur : SidourAvoda.app introuvable dans $SCRIPT_DIR"
            echo "Assurez-vous que l'app est dans le mÃªme dossier que ce script."
            read -p "Appuyez sur EntrÃ©e pour fermer..."
            exit 1
          fi
          
          echo "ðŸ“± Suppression de l'attribut de quarantaine..."
          xattr -dr com.apple.quarantine "$APP_PATH" 2>/dev/null || {
            echo "âš ï¸  Impossible de supprimer la quarantaine automatiquement."
            echo "Essayez la Solution 1 (clic droit > Ouvrir) ou la Solution 3 (Terminal)."
            read -p "Appuyez sur EntrÃ©e pour fermer..."
            exit 1
          }
          
          echo "âœ… Quarantaine supprimÃ©e avec succÃ¨s !"
          echo "ðŸš€ Lancement de Sidour Avoda..."
          
          # Open the app
          open "$APP_PATH"
          
          echo "âœ… Sidour Avoda devrait maintenant s'ouvrir !"
          echo "Fermez cette fenÃªtre."
          sleep 2
          SH
          
          chmod +x "$STAGE/ðŸ”“ Ouvrir-SidourAvoda.command"
          
          # Create DMG
          hdiutil create -volname "SidourAvoda" -srcfolder "$STAGE" -ov -format UDZO "$DMG_NAME"
          echo "DMG created: $DMG_NAME"

      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: sidour-avoda-macos-${{ matrix.runner }}
          path: |
            SidourAvoda-*.dmg
            dist/**
            Sidour-avoda-Tzora-chevron/dist/**

  # Optional: Notarization job (requires Apple Developer account)
  notarize:
    name: Notarize App (Optional)
    runs-on: macos-14
    needs: build
    if: ${{ false }}  # Set to true if you have Apple Developer credentials
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: sidour-avoda-macos-macos-14
          path: ./artifacts
      
      - name: Setup notarization
        run: |
          # This would require Apple Developer credentials
          # For free notarization, you need:
          # 1. Apple Developer account (free)
          # 2. App-specific password
          # 3. Team ID
          echo "Notarization requires Apple Developer credentials"
          echo "To enable:"
          echo "1. Create free Apple Developer account"
          echo "2. Add secrets: APPLE_ID, APPLE_APP_SPECIFIC_PASSWORD, TEAM_ID"
          echo "3. Set if: \${{ false }} to if: \${{ true }}"


